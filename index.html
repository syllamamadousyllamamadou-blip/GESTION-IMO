<!DOCTYPE html>
<html lang="fr" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-IMMO | Gestion Complète CI (Finale)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- JSZip & FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" xintegrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwWWfokGNhBNlE8lTxlGYTqBvnyfK750q1re5pt+vwDDi4PB0pvX66HomspQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" xintegrity="sha512-Qwa0tco3Ka6BnL+SYwKuT99sdXgHGk0PSRiHJrD64OzsXQo4e1PSP65le5zX48u7y/0wvGxs7y/k7v/Q2bo++A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' },
                        sidebar: '#0f172a'
                    }
                }
            }
        }
    </script>
    <!-- CORRECTION ICI: Ajout de type="text/tailwindcss" pour supporter @apply -->
    <style type="text/tailwindcss">
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
        }
        .card { @apply bg-white rounded-xl border border-slate-200 shadow-sm transition-all duration-200; }
        .card:hover { @apply shadow-md border-slate-300; }
        .input-clean { @apply w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-2.5 transition-colors; }
        .btn-brand { @apply text-white bg-brand-600 hover:bg-brand-700 font-medium rounded-lg text-sm px-4 py-2 text-center inline-flex items-center gap-2 transition-colors shadow-sm; }
    </style>
</head>
<body class="h-full text-slate-800 antialiased overflow-hidden selection:bg-brand-100">

    <!-- Notifications -->
    <div id="toast-container" class="fixed top-5 right-5 z-[60] flex flex-col gap-2 pointer-events-none"></div>

    <!-- App Container -->
    <div id="app-screen" class="flex h-full flex-col md:flex-row">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-sidebar w-full md:w-64 flex-shrink-0 flex flex-col border-r border-slate-800 transition-all duration-300 hidden md:flex no-print h-full z-40 relative">
            <div class="h-16 flex items-center px-6 bg-slate-900 border-b border-slate-800">
                <i data-lucide="building-2" class="text-brand-500 mr-3 h-6 w-6"></i>
                <div>
                    <h1 class="text-lg font-bold tracking-wide text-white">G-IMMO</h1>
                    <span class="text-[10px] text-orange-400 font-mono uppercase tracking-wider">Édition CI</span>
                </div>
            </div>

            <!-- Recherche Globale -->
            <div class="px-4 py-4 border-b border-slate-800">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i data-lucide="search" class="w-4 h-4 text-slate-500"></i>
                    </div>
                    <input type="text" id="global-search" placeholder="Chercher un client..." class="bg-slate-800 border border-slate-700 text-slate-300 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block w-full pl-10 p-2 placeholder-slate-500">
                </div>
                <div id="search-results" class="absolute left-4 right-4 mt-1 bg-white rounded-lg shadow-xl z-50 hidden max-h-60 overflow-y-auto border border-slate-200"></div>
            </div>

            <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
                <a href="#" data-view="dashboard" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="layout-dashboard" class="mr-3 h-5 w-5 opacity-70"></i> Tableau de bord
                </a>

                <div class="mt-6 mb-2 px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Gestion</div>
                <a href="#" data-view="properties" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="home" class="mr-3 h-5 w-5 opacity-70"></i> Biens
                </a>
                <a href="#" data-view="tenants" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="users" class="mr-3 h-5 w-5 opacity-70"></i> Locataires
                </a>
                <a href="#" data-view="leases" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="file-contract" class="mr-3 h-5 w-5 opacity-70"></i> Baux & Contrats
                </a>

                <div class="mt-6 mb-2 px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Comptabilité</div>
                <a href="#" data-view="finance" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="banknote" class="mr-3 h-5 w-5 opacity-70"></i> Transactions
                </a>
                <a href="#" data-view="reports" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="file-spreadsheet" class="mr-3 h-5 w-5 opacity-70"></i> Bilans & Exports
                </a>

                <div class="mt-6 mb-2 px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Système</div>
                <a href="#" data-view="settings" class="nav-link group flex items-center px-3 py-2 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="database-backup" class="mr-3 h-5 w-5 opacity-70"></i> Sauvegardes
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 relative">
            <div class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center no-print shadow-md z-30">
                <span class="font-bold text-lg">G-IMMO CI</span>
                <button id="mobile-menu-btn" class="p-2 text-slate-300 hover:text-white"><i data-lucide="menu"></i></button>
            </div>
            
            <div id="view-container" class="flex-1 overflow-hidden relative"></div>
        </main>
    </div>

    <!-- Global Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity no-print">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100 max-h-[90vh] overflow-y-auto border border-slate-200"></div>
    </div>

    <!-- Loader Overlay -->
    <div id="loader" class="fixed inset-0 bg-white/80 z-[70] hidden flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-600"></div>
        <p class="mt-4 text-slate-600 font-medium" id="loader-text">Traitement...</p>
    </div>

    <script>
        // --- 1. MOTEUR DE BASE DE DONNÉES ---
        
        const DB_NAME = 'GImmoCIDB';
        const DB_VERSION = 1;
        const STORE_FILES = 'files';

        const dbEngine = {
            init: () => new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains(STORE_FILES)) e.target.result.createObjectStore(STORE_FILES, { keyPath: 'id' }); };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            }),
            saveFile: async (fileObj) => {
                const db = await dbEngine.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_FILES], 'readwrite');
                    const record = { id: crypto.randomUUID(), name: fileObj.name, type: fileObj.type, blob: fileObj, date: new Date().toISOString() };
                    tx.objectStore(STORE_FILES).add(record).onsuccess = () => resolve(record.id);
                    tx.onerror = () => reject(tx.error);
                });
            },
            saveRestoredFile: async (fileRecord) => {
                const db = await dbEngine.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_FILES], 'readwrite');
                    tx.objectStore(STORE_FILES).put(fileRecord).onsuccess = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            getFile: async (id) => {
                const db = await dbEngine.init();
                return new Promise((resolve) => {
                    db.transaction([STORE_FILES], 'readonly').objectStore(STORE_FILES).get(id).onsuccess = (e) => resolve(e.target.result);
                });
            },
            getAllFiles: async () => {
                const db = await dbEngine.init();
                return new Promise(resolve => {
                    db.transaction([STORE_FILES], 'readonly').objectStore(STORE_FILES).getAll().onsuccess = e => resolve(e.target.result);
                });
            },
            clearFiles: async () => {
                const db = await dbEngine.init();
                return new Promise(resolve => {
                    db.transaction([STORE_FILES], 'readwrite').objectStore(STORE_FILES).clear().onsuccess = () => resolve();
                });
            }
        };

        // --- 2. STORE ---

        const initialState = {
            properties: [],
            tenants: [],
            leases: [],
            payments: [],
            expenses: [],
            logs: [],
            profile: { fullname: 'Mon Agence Immobilière', currency: 'FCFA' }
        };

        const store = {
            data: { ...initialState },
            load: () => {
                const stored = localStorage.getItem('g_immo_ci_v2_data');
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        if(parsed && typeof parsed === 'object') store.data = { ...initialState, ...parsed };
                    } catch(e) { console.error("Données locales corrompues"); }
                }
            },
            save: () => {
                if(store.data.logs.length > 500) {
                    store.data.logs = store.data.logs.slice(0, 500);
                }
                try {
                    localStorage.setItem('g_immo_ci_v2_data', JSON.stringify(store.data));
                } catch(e) {
                    alert("Espace disque saturé. Impossible de sauvegarder.");
                }
            },
            log: (action, details, category = 'info') => {
                store.data.logs.unshift({ id: crypto.randomUUID(), date: new Date().toISOString(), action, details, category });
                store.save();
            },
            add: (col, item) => { item.id = crypto.randomUUID(); item.createdAt = new Date().toISOString(); store.data[col].push(item); store.save(); return item; },
            update: (col, id, updates) => { const i = store.data[col].findIndex(x => x.id === id); if(i>-1) { store.data[col][i] = {...store.data[col][i], ...updates}; store.save(); return true; } return false; },
            delete: (col, id) => { store.data[col] = store.data[col].filter(x => x.id !== id); store.save(); },
            get: (col, id) => store.data[col].find(x => x.id === id)
        };

        // --- 3. UTILS ---

        const formatCurrency = (n) => new Intl.NumberFormat('fr-FR').format(n || 0) + ' FCFA';
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('fr-FR') : '-';
        const escapeHtml = (s) => (s || '').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        const loader = {
            show: (txt = 'Chargement...') => { document.getElementById('loader-text').innerText = txt; document.getElementById('loader').classList.remove('hidden'); },
            hide: () => document.getElementById('loader').classList.add('hidden')
        };

        const showToast = (msg, type = 'success') => {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            d.className = `${type === 'success' ? 'bg-emerald-600' : 'bg-rose-600'} text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 transform transition-all duration-300 translate-x-full max-w-sm pointer-events-auto`;
            d.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-octagon'}" class="w-5 h-5"></i><span class="font-medium text-sm">${msg}</span>`;
            c.appendChild(d);
            lucide.createIcons();
            requestAnimationFrame(() => d.classList.remove('translate-x-full'));
            setTimeout(() => { d.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => d.remove(), 300); }, 3000);
        };

        const getPaymentStatus = (lease, periodStr) => {
            const payments = store.data.payments.filter(p => p.leaseId === lease.id && p.period === periodStr);
            const totalPaid = payments.reduce((sum, p) => sum + parseFloat(p.amount), 0);
            
            const [y, m] = periodStr.split('-');
            const limitDate = new Date(parseInt(y), parseInt(m) - 1, 10, 23, 59, 59);
            const now = new Date();

            if (totalPaid >= parseFloat(lease.rentAmount)) return { label: 'Payé', color: 'bg-emerald-100 text-emerald-800' };
            if (totalPaid > 0) return { label: 'Partiel', color: 'bg-amber-100 text-amber-800' };
            if (now > limitDate) return { label: 'En retard', color: 'bg-rose-100 text-rose-800' };
            return { label: 'En attente', color: 'bg-slate-100 text-slate-600' };
        };

        // --- 4. VUES ---

        const router = {
            current: 'dashboard',
            params: {},
            navigate: (view, params = {}) => {
                router.current = view;
                router.params = params;
                render();
            }
        };

        const components = {
            header: (title, subtitle, action = '') => `
                <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 sticky top-0 z-20 shadow-sm no-print">
                    <div><h2 class="text-xl font-bold text-slate-800">${title}</h2>${subtitle ? `<p class="text-xs text-slate-500 mt-0.5">${subtitle}</p>` : ''}</div>
                    <div class="flex gap-2">${action}</div>
                </header>
            `,
            statusBadge: (status, type='lease') => {
                if(type === 'lease') {
                    if(status === 'active') return `<span class="px-2 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-800">Actif</span>`;
                    if(status === 'archived') return `<span class="px-2 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-500">Clôturé</span>`;
                }
                return `<span>${status}</span>`;
            }
        };

        const views = {
            dashboard: () => { 
                const activeLeases = store.data.leases.filter(l => l.status === 'active');
                const income = store.data.payments.reduce((s, p) => s + parseFloat(p.amount), 0);
                return `
                    ${components.header('Tableau de Bord', 'Aperçu global de l\'activité')}
                    <div class="p-6 overflow-y-auto h-full pb-24">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                             <div class="card p-5 border-l-4 border-l-brand-500"><p class="text-slate-500 text-xs font-bold uppercase">Biens Gérés</p><p class="text-2xl font-bold text-slate-800 mt-1">${store.data.properties.length}</p></div>
                             <div class="card p-5 border-l-4 border-l-emerald-500"><p class="text-slate-500 text-xs font-bold uppercase">Baux Actifs</p><p class="text-2xl font-bold text-slate-800 mt-1">${activeLeases.length}</p></div>
                             <div class="card p-5 border-l-4 border-l-indigo-500"><p class="text-slate-500 text-xs font-bold uppercase">Cautions Détenues</p><p class="text-2xl font-bold text-slate-800 mt-1">${formatCurrency(activeLeases.reduce((s,l)=>s+parseFloat(l.depositAmount||0),0))}</p></div>
                             <div class="card p-5 border-l-4 border-l-rose-500"><p class="text-slate-500 text-xs font-bold uppercase">Revenus</p><p class="text-2xl font-bold text-slate-800 mt-1">${formatCurrency(income)}</p></div>
                        </div>
                        <div class="card p-5 bg-gradient-to-br from-brand-900 to-slate-900 text-white">
                            <h3 class="font-bold mb-2">Actions Rapides</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="actions.openAddPayment()" class="bg-white/10 hover:bg-white/20 p-3 rounded-lg text-left transition"><i data-lucide="plus-circle" class="mb-2 w-5 h-5 text-emerald-400"></i><br>Encaisser Loyer</button>
                                <button onclick="actions.openCreateLease()" class="bg-white/10 hover:bg-white/20 p-3 rounded-lg text-left transition"><i data-lucide="file-plus" class="mb-2 w-5 h-5 text-blue-400"></i><br>Nouveau Bail</button>
                            </div>
                        </div>
                    </div>`;
            },
            properties: () => { 
                return `${components.header('Biens', 'Parc Immobilier', `<button onclick="actions.openCreateProperty()" class="btn-brand">Ajouter</button>`)}
                <div class="p-6 overflow-y-auto h-full pb-24 grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${store.data.properties.map(p => `
                    <div class="card p-5">
                        <div class="flex justify-between items-start mb-2">
                            <span class="bg-slate-100 text-slate-600 text-[10px] uppercase font-bold px-2 py-1 rounded tracking-wide">${escapeHtml(p.type)}</span>
                            <button onclick="actions.deleteItem('properties','${p.id}','Bien')" class="text-rose-500 hover:text-rose-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <h3 class="font-bold text-lg">${escapeHtml(p.nickname)}</h3>
                        <p class="text-sm text-slate-500 flex items-center gap-1 mt-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${escapeHtml(p.address)}</p>
                    </div>`).join('')}
                </div>`; 
            },
            tenants: () => { 
                return `${components.header('Locataires', 'Répertoire Clients', `<button onclick="actions.openCreateTenant()" class="btn-brand">Ajouter</button>`)}
                <div class="p-6 overflow-y-auto h-full pb-24 space-y-2">
                    ${store.data.tenants.map(t => `
                    <div class="card p-4 flex justify-between cursor-pointer hover:bg-slate-50" onclick="router.navigate('tenantDetail', {id: '${t.id}'})">
                        <div>
                            <p class="font-bold">${escapeHtml(t.lastname)} ${escapeHtml(t.firstname)}</p>
                            <p class="text-xs text-slate-500">${escapeHtml(t.phone)}</p>
                        </div>
                        <i data-lucide="chevron-right" class="text-slate-400"></i>
                    </div>`).join('')}
                </div>`; 
            },
            tenantDetail: () => { 
                const t = store.get('tenants', router.params.id);
                if (!t) return views.tenants();
                const leases = store.data.leases.filter(l => l.tenantId === t.id);
                const activeLease = leases.find(l => l.status === 'active');
                
                return `${components.header(t.lastname, 'Fiche client complète', `<button onclick="router.navigate('tenants')" class="text-sm border px-3 py-1 rounded bg-white">Retour</button>`)}
                <div class="p-6 overflow-y-auto h-full pb-24 space-y-6">
                    <div class="card p-6 flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold text-slate-900">${t.firstname} ${t.lastname}</h3>
                            <p class="text-slate-500">${t.phone}</p>
                        </div>
                        ${activeLease ? 
                            `<button onclick="actions.closeLease('${activeLease.id}')" class="text-rose-600 border border-rose-200 hover:bg-rose-50 px-3 py-1.5 rounded text-sm flex gap-2"><i data-lucide="user-x" class="w-4 h-4"></i> Signaler Départ</button>` 
                            : '<span class="text-slate-400 text-sm">Aucun bail actif</span>'}
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-slate-500 text-sm uppercase mb-2">Historique des Baux</h4>
                        ${leases.map(l => views.renderLeaseCard(l, l.status === 'active')).join('')}
                    </div>
                </div>`;
            },
            renderLeaseCard: (lease, isActive) => {
                const prop = store.get('properties', lease.propertyId);
                const payments = store.data.payments.filter(p => p.leaseId === lease.id).sort((a,b) => b.date.localeCompare(a.date));
                return `<div class="card p-4 mb-4 ${isActive?'border-brand-500 ring-1 ring-brand-100': 'opacity-75 bg-slate-50'}">
                    <div class="flex justify-between mb-2">
                        <p class="font-bold text-lg">${prop?.nickname}</p>
                        ${components.statusBadge(lease.status)}
                    </div>
                    <div class="flex gap-4 text-sm mb-4">
                        <span>Loyer: <strong>${formatCurrency(lease.rentAmount)}</strong></span>
                        <span>Caution: <strong>${formatCurrency(lease.depositAmount)}</strong></span>
                    </div>
                    ${lease.contractFileId ? `<button onclick="actions.viewFile('${lease.contractFileId}')" class="text-xs text-brand-600 mb-4 flex gap-1"><i data-lucide="file-text" class="w-3 h-3"></i> Voir Contrat PDF</button>` : ''}
                    
                    <div class="bg-slate-50 rounded p-2">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">Paiements</p>
                        ${payments.map(p => {
                            const st = getPaymentStatus(lease, p.period);
                            return `<div class="flex justify-between text-sm border-b border-slate-200 pb-1 mb-1 last:border-0">
                                <span class="font-mono text-slate-600">${p.period}</span>
                                <span class="font-bold">${formatCurrency(p.amount)}</span>
                                <span class="text-[10px] px-1 rounded ${st.color}">${st.label}</span>
                                ${p.receiptFileId ? `<button onclick="actions.viewFile('${p.receiptFileId}')"><i data-lucide="file-check" class="w-3 h-3 text-emerald-600"></i></button>` : ''}
                            </div>`
                        }).join('')}
                        ${payments.length === 0 ? '<p class="text-xs text-slate-400 italic">Aucun paiement</p>' : ''}
                    </div>
                </div>`;
            },
            leases: () => { return `${components.header('Baux Actifs', 'Contrats en cours', `<button onclick="actions.openCreateLease()" class="btn-brand">Nouveau</button>`)}<div class="p-6 overflow-y-auto h-full pb-24 space-y-3">${store.data.leases.filter(l=>l.status==='active').map(l => {
                const p = store.get('properties', l.propertyId);
                const t = store.get('tenants', l.tenantId);
                return `<div class="card p-4 flex justify-between items-center">
                    <div>
                        <p class="font-bold">${t?.lastname} ${t?.firstname}</p>
                        <p class="text-sm text-slate-500">${p?.nickname} - ${formatCurrency(l.rentAmount)}</p>
                    </div>
                    <button onclick="actions.openAddPayment('${l.id}')" class="text-emerald-600 bg-emerald-50 hover:bg-emerald-100 px-3 py-1 rounded text-xs font-bold">Payer</button>
                </div>`;
            }).join('')}</div>`; },
            finance: () => { return `${components.header('Finance', 'Sorties Bailleurs', `<button onclick="actions.openCreateExpense()" class="btn-brand bg-rose-600">Sortie</button>`)}<div class="p-6 overflow-y-auto h-full pb-24 space-y-2">${store.data.expenses.map(e => `<div class="card p-4 flex justify-between"><p>${escapeHtml(e.description)} <span class="text-xs text-slate-400 block">${formatDate(e.date)}</span></p><div class="text-right"><p class="text-rose-600 font-bold">-${formatCurrency(e.amount)}</p>${e.fileId?`<button onclick="actions.viewFile('${e.fileId}')" class="text-xs text-brand-600 underline">Justificatif</button>`:''}</div></div>`).join('')}</div>`; },
            reports: () => `
                ${components.header('Bilans & Exports', 'Extraction de données')}
                <div class="p-6 overflow-y-auto h-full pb-24 max-w-3xl mx-auto space-y-6">
                    <div class="card p-6">
                        <h3 class="font-bold text-slate-800 text-lg">Export Transactions (CSV)</h3>
                        <form onsubmit="actions.exportTransactions(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-100 mt-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Date Début</label><input type="date" name="start" required class="input-clean"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Date Fin</label><input type="date" name="end" required class="input-clean"></div>
                            <div class="md:col-span-2 text-right"><button type="submit" class="btn-brand">Générer CSV</button></div>
                        </form>
                    </div>
                </div>`,
            settings: () => `
                ${components.header('Sauvegarde', 'Sécurité')}
                <div class="p-6 overflow-y-auto h-full pb-24 max-w-2xl mx-auto space-y-6">
                    <div class="card p-6 border-l-4 border-brand-500">
                        <h3 class="font-bold mb-2 text-lg">Sauvegarde Complète (ZIP)</h3>
                        <p class="text-sm text-slate-500 mb-4">Télécharge une archive contenant la base de données JSON et tous les fichiers PDF numérisés.</p>
                        <button onclick="actions.backupFull()" class="btn-brand w-full py-3">Télécharger Backup</button>
                    </div>
                    <div class="card p-6 border-l-4 border-amber-500">
                        <h3 class="font-bold mb-2 text-lg">Restauration Système</h3>
                        <p class="text-sm text-slate-500 mb-4">Importez un fichier .zip pour restaurer l'intégralité du système (écrase les données actuelles).</p>
                        <input type="file" id="restore-file" accept=".zip" class="block w-full text-sm mb-4 bg-slate-50 p-2 rounded border"/>
                        <button onclick="actions.restoreFull()" class="btn-brand bg-amber-600 w-full hover:bg-amber-700">Restaurer</button>
                    </div>
                    <div class="text-center mt-8">
                        <button onclick="if(confirm('Tout effacer ? Action irréversible.')) { localStorage.removeItem('g_immo_ci_v2_data'); dbEngine.clearFiles().then(() => location.reload()); }" class="text-rose-500 text-sm hover:underline">Réinitialiser l'application à zéro</button>
                    </div>
                </div>`
        };

        // --- 5. ACTIONS & HANDLERS ---

        const actions = {
            openCreateProperty: () => modal.open('Nouveau Bien', `
                <form onsubmit="handlers.createProperty(event)" class="space-y-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Nom</label><input name="nickname" required class="input-clean" placeholder="Ex: Villa Cocody"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Adresse</label><input name="address" required class="input-clean"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Type</label>
                        <select name="type" class="input-clean">
                            <option>Appartement</option><option>Villa</option><option>Studio</option><option>Bureau</option><option>Magasin</option><option>Penthouse</option>
                        </select>
                    </div>
                    <button class="btn-brand mt-4 w-full">Créer</button>
                </form>`),
            
            openCreateTenant: () => modal.open('Nouveau Locataire', `<form onsubmit="handlers.createTenant(event)" class="space-y-4"><div><label class="text-xs font-bold text-slate-500 uppercase">Nom</label><input name="lastname" required class="input-clean"></div><div><label class="text-xs font-bold text-slate-500 uppercase">Prénom</label><input name="firstname" required class="input-clean"></div><div><label class="text-xs font-bold text-slate-500 uppercase">Téléphone</label><input name="phone" required class="input-clean"></div><button class="btn-brand mt-4 w-full">Créer</button></form>`),
            
            openCreateLease: () => {
                const props = store.data.properties.map(p => `<option value="${p.id}">${escapeHtml(p.nickname)} (${p.type})</option>`).join('');
                const tens = store.data.tenants.map(t => `<option value="${t.id}">${escapeHtml(t.lastname)} ${escapeHtml(t.firstname)}</option>`).join('');
                if(!props || !tens) return showToast('Créez d\'abord un bien et un locataire', 'error');
                
                modal.open('Nouveau Bail', `
                <form onsubmit="handlers.createLease(event)" class="space-y-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Bien</label><select name="propertyId" class="input-clean">${props}</select></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Locataire</label><select name="tenantId" class="input-clean">${tens}</select></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Loyer</label><input type="number" name="rentAmount" required class="input-clean"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Caution</label><input type="number" name="depositAmount" required class="input-clean"></div>
                    </div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Date Entrée</label><input type="date" name="startDate" required class="input-clean"></div>
                    <div><label class="text-xs font-bold text-brand-600 uppercase">Contrat PDF</label><input type="file" name="file" accept="application/pdf" class="input-clean"></div>
                    <button class="btn-brand mt-4 w-full">Valider le Bail</button>
                </form>`);
            },
            
            openAddPayment: (pid=null) => {
                const activeLeases = store.data.leases.filter(l => l.status === 'active');
                if(activeLeases.length === 0) return showToast('Aucun bail actif', 'error');

                const opts = activeLeases.map(l => {
                    const p = store.get('properties', l.propertyId);
                    const t = store.get('tenants', l.tenantId);
                    return `<option value="${l.id}" ${l.id===pid?'selected':''}>${t.lastname} - ${p.nickname} (${formatCurrency(l.rentAmount)})</option>`;
                }).join('');
                
                modal.open('Encaisser Loyer', `
                <form onsubmit="handlers.createPayment(event)" class="space-y-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Bail</label><select name="leaseId" class="input-clean">${opts}</select></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Période</label><input type="month" name="period" required class="input-clean"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Montant</label><input type="number" name="amount" required class="input-clean"></div>
                    </div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Date</label><input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="input-clean"></div>
                    <div><label class="text-xs font-bold text-emerald-600 uppercase">Reçu PDF</label><input type="file" name="file" accept="application/pdf" class="input-clean"></div>
                    <button class="btn-brand mt-4 w-full bg-emerald-600 hover:bg-emerald-700">Payer</button>
                </form>`);
            },
            
            openCreateExpense: () => modal.open('Sortie Bailleur', `<form onsubmit="handlers.createExpense(event)" class="space-y-4"><input name="description" placeholder="Motif" required class="input-clean"><input type="number" name="amount" required class="input-clean"><input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="input-clean"><div><label class="text-xs font-bold text-rose-600 uppercase">Justificatif PDF</label><input type="file" name="file" accept="application/pdf" class="input-clean"></div><button class="btn-brand mt-4 bg-rose-600">Enregistrer Sortie</button></form>`),
            
            closeLease: (id) => {
                if(confirm("Confirmer le départ du locataire ? Le bail sera archivé.")) {
                    store.update('leases', id, { status: 'archived', endDate: new Date().toISOString() });
                    render();
                    showToast('Bail clôturé');
                }
            },

            deleteItem: (col, id) => { if(confirm('Supprimer ?')) { store.delete(col, id); render(); } },
            viewFile: async (id) => { try { const f = await dbEngine.getFile(id); window.open(URL.createObjectURL(f.blob)); } catch(e){} },
            
            exportTransactions: (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const start = new Date(fd.get('start'));
                const end = new Date(fd.get('end')); end.setHours(23, 59, 59);

                const lines = [];
                lines.push("Date;Type;Description;Montant");
                
                store.data.payments.forEach(p => {
                    const d = new Date(p.date);
                    if(d>=start && d<=end) {
                        const l = store.get('leases', p.leaseId);
                        const t = l ? store.get('tenants', l.tenantId) : null;
                        lines.push(`${formatDate(p.date)};Loyer;${t?t.lastname:''} (${p.period});${p.amount}`);
                    }
                });
                store.data.expenses.forEach(e => {
                     const d = new Date(e.date);
                    if(d>=start && d<=end) lines.push(`${formatDate(e.date)};Sortie;${e.description};-${e.amount}`);
                });
                
                const blob = new Blob(["\ufeff"+lines.join("\n")], {type: 'text/csv'});
                saveAs(blob, "transactions.csv");
            },
            
            backupFull: async () => {
                loader.show('Génération du Backup...');
                try {
                    const zip = new JSZip();
                    zip.file("data.json", JSON.stringify(store.data));
                    const allFiles = await dbEngine.getAllFiles();
                    
                    if(allFiles.length > 50 && !confirm(`Attention: ${allFiles.length} fichiers PDF détectés. La sauvegarde peut être longue. Continuer ?`)) {
                        loader.hide(); return;
                    }
                    
                    const folder = zip.folder("documents_pdf");
                    allFiles.forEach(f => folder.file(`${f.id}.pdf`, f.blob));
                    
                    const content = await zip.generateAsync({type:"blob"});
                    saveAs(content, `G-IMMO_BACKUP_${new Date().toISOString().slice(0,10)}.zip`);
                } catch(e) {
                    alert("Erreur lors du backup: " + e.message);
                } finally {
                    loader.hide();
                }
            },
            
            restoreFull: async () => {
                const input = document.getElementById('restore-file');
                if(!input.files[0]) return alert('Sélectionnez un fichier ZIP.');
                if(!confirm("ATTENTION: Toutes les données actuelles seront remplacées. Continuer ?")) return;

                loader.show('Restauration...');
                try {
                    const zip = await JSZip.loadAsync(input.files[0]);
                    const dataStr = await zip.file("data.json").async("string");
                    const dataObj = JSON.parse(dataStr);
                    
                    await dbEngine.clearFiles();
                    const folder = zip.folder("documents_pdf");
                    if(folder) {
                        const promises = [];
                        folder.forEach((path, file) => {
                            promises.push(file.async("blob").then(blob => {
                                const id = path.replace('.pdf', '');
                                return dbEngine.saveRestoredFile({
                                    id: id,
                                    name: "Restored",
                                    type: "application/pdf",
                                    blob: blob,
                                    date: new Date().toISOString()
                                });
                            }));
                        });
                        await Promise.all(promises);
                    }
                    
                    store.data = dataObj;
                    store.save();
                    location.reload();
                } catch(e) {
                    alert("Erreur restauration: " + e.message);
                    loader.hide();
                }
            }
        };

        const handlers = {
            createProperty: (e) => { e.preventDefault(); store.add('properties', Object.fromEntries(new FormData(e.target))); modal.close(); render(); showToast('Bien créé'); },
            createTenant: (e) => { e.preventDefault(); store.add('tenants', Object.fromEntries(new FormData(e.target))); modal.close(); render(); showToast('Locataire créé'); },
            createLease: async (e) => { 
                e.preventDefault(); const fd = new FormData(e.target);
                const file = fd.get('file'); let fid = null;
                if(file.size > 0) fid = await dbEngine.saveFile(file);
                store.add('leases', {...Object.fromEntries(fd), status: 'active', contractFileId: fid}); 
                modal.close(); render(); showToast('Bail créé');
            },
            createPayment: async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const lid = fd.get('leaseId');
                const per = fd.get('period');
                const amt = parseFloat(fd.get('amount'));
                
                const lease = store.get('leases', lid);
                const existing = store.data.payments.filter(p => p.leaseId === lid && p.period === per);
                const sumExisting = existing.reduce((s, p) => s + parseFloat(p.amount), 0);
                
                if (sumExisting + amt > parseFloat(lease.rentAmount)) {
                    alert(`Erreur: Le montant total (${sumExisting + amt}) dépasse le loyer (${lease.rentAmount}).`);
                    return;
                }
                
                const file = fd.get('file'); let fid = null;
                if(file.size > 0) fid = await dbEngine.saveFile(file);

                store.add('payments', {...Object.fromEntries(fd), receiptFileId: fid});
                modal.close(); render(); showToast('Paiement enregistré');
            },
            createExpense: async (e) => { 
                e.preventDefault(); const fd = new FormData(e.target);
                const file = fd.get('file'); let fid = null;
                if(file.size > 0) fid = await dbEngine.saveFile(file);
                store.add('expenses', {...Object.fromEntries(fd), fileId: fid}); 
                modal.close(); render(); showToast('Sortie enregistrée');
            }
        };

        const modal = {
            open: (t, c) => { document.getElementById('modal-content').innerHTML = `<div class="p-4 border-b bg-slate-50 flex justify-between items-center"><h3 class="font-bold text-slate-800">${t}</h3><button onclick="modal.close()" class="text-slate-400"><i data-lucide="x"></i></button></div><div class="p-6">${c}</div>`; document.getElementById('modal-backdrop').classList.remove('hidden'); },
            close: () => document.getElementById('modal-backdrop').classList.add('hidden')
        };

        const render = () => {
            const v = views[router.current] || views.dashboard;
            document.getElementById('view-container').innerHTML = v();
            lucide.createIcons();
        };

        const init = async () => {
            store.load();
            document.getElementById('sidebar').addEventListener('click', e => { const l = e.target.closest('.nav-link'); if(l) router.navigate(l.dataset.view); });
            document.getElementById('mobile-menu-btn').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('hidden'));
            
            // Search
            const search = document.getElementById('global-search');
            const resBox = document.getElementById('search-results');
            search.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase().replace(/[<>]/g, '');
                if(val.length < 2) { resBox.classList.add('hidden'); return; }
                const hits = store.data.tenants.filter(t => t.lastname.toLowerCase().includes(val) || t.firstname.toLowerCase().includes(val));
                resBox.innerHTML = hits.map(t => `<div class="p-3 hover:bg-slate-50 cursor-pointer border-b text-sm" onclick="router.navigate('tenantDetail', {id:'${t.id}'}); document.getElementById('search-results').classList.add('hidden')"><strong>${escapeHtml(t.lastname)} ${escapeHtml(t.firstname)}</strong><br><span class="text-xs text-slate-500">${t.phone}</span></div>`).join('') || '<div class="p-3 text-xs text-slate-400">Aucun résultat</div>';
                resBox.classList.remove('hidden');
            });
            document.addEventListener('click', (e) => { if(!e.target.closest('#global-search')) resBox.classList.add('hidden'); });

            render();
        };
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
