<!DOCTYPE html>
<html lang="fr" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G-IMMO | Mobile Optimized</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['Courier Prime', 'monospace'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' },
                        sidebar: '#0f172a'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; height: auto; overflow: visible; }
            #receipt-print-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: white; }
            #app-screen, #login-screen, #modal-backdrop, #mobile-sidebar-backdrop { display: none; }
        }
        .card { @apply bg-white rounded-xl border border-slate-200 shadow-sm transition-all duration-200; }
        .card:hover { @apply shadow-md border-slate-300; }
        .input-clean { @apply w-full bg-slate-50 border border-slate-200 text-slate-900 text-base rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-3 transition-colors; } /* Increased padding/text size for touch */
        .btn-brand { @apply text-white bg-brand-600 hover:bg-brand-700 font-medium rounded-lg text-sm px-4 py-3 text-center inline-flex items-center justify-center gap-2 transition-colors shadow-sm active:scale-95; }
        
        /* Keypad Styles */
        .keypad-btn { @apply w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-slate-800 text-white text-xl sm:text-2xl font-bold flex items-center justify-center active:bg-brand-600 active:scale-90 transition-all shadow-lg select-none cursor-pointer tap-highlight-transparent; }
        .pin-dot { @apply w-3 h-3 sm:w-4 sm:h-4 rounded-full border-2 border-slate-400 transition-colors; }
        .pin-dot.active { @apply bg-brand-500 border-brand-500; }
        .pin-dot.error { @apply bg-rose-500 border-rose-500 animate-pulse; }
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="h-full text-slate-800 antialiased overflow-hidden selection:bg-brand-100 bg-slate-100">

    <!-- LOGIN SCREEN (MOBILE OPTIMIZED) -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-4">
        <div class="mb-6 sm:mb-8 text-center">
            <i data-lucide="building-2" class="w-10 h-10 sm:w-12 sm:h-12 text-brand-500 mx-auto mb-3 sm:mb-4"></i>
            <h1 class="text-xl sm:text-2xl font-bold text-white tracking-widest">G-IMMO</h1>
            <p class="text-slate-400 text-xs sm:text-sm mt-1">Accès Sécurisé</p>
        </div>

        <!-- Pin Dots -->
        <div class="flex gap-4 mb-8 sm:mb-10">
            <div id="dot-1" class="pin-dot"></div>
            <div id="dot-2" class="pin-dot"></div>
            <div id="dot-3" class="pin-dot"></div>
            <div id="dot-4" class="pin-dot"></div>
        </div>

        <!-- Keypad -->
        <div class="grid grid-cols-3 gap-4 sm:gap-6 max-w-xs mx-auto">
            <div class="keypad-btn" onclick="auth.press(1)">1</div>
            <div class="keypad-btn" onclick="auth.press(2)">2</div>
            <div class="keypad-btn" onclick="auth.press(3)">3</div>
            <div class="keypad-btn" onclick="auth.press(4)">4</div>
            <div class="keypad-btn" onclick="auth.press(5)">5</div>
            <div class="keypad-btn" onclick="auth.press(6)">6</div>
            <div class="keypad-btn" onclick="auth.press(7)">7</div>
            <div class="keypad-btn" onclick="auth.press(8)">8</div>
            <div class="keypad-btn" onclick="auth.press(9)">9</div>
            <div class="keypad-btn flex items-center justify-center bg-transparent shadow-none active:bg-transparent text-rose-500" onclick="auth.clear()"><i data-lucide="delete" class="w-6 h-6 sm:w-8 sm:h-8"></i></div>
            <div class="keypad-btn" onclick="auth.press(0)">0</div>
            <div class="keypad-btn flex items-center justify-center bg-transparent shadow-none active:bg-transparent" onclick="auth.check()"><i data-lucide="arrow-right" class="w-8 h-8 sm:w-10 sm:h-10 text-emerald-500"></i></div>
        </div>
        <p class="mt-8 text-slate-600 text-[10px] sm:text-xs">Version Mobile 2.5 (Native)</p>
    </div>

    <!-- Notifications -->
    <div id="toast-container" class="fixed top-16 right-4 left-4 sm:left-auto sm:right-5 z-[80] flex flex-col gap-2 pointer-events-none no-print"></div>

    <!-- App Container -->
    <div id="app-screen" class="flex h-full flex-col md:flex-row hidden opacity-0 transition-opacity duration-500">
        
        <!-- Mobile Sidebar Backdrop -->
        <div id="mobile-sidebar-backdrop" class="fixed inset-0 bg-slate-900/60 z-30 hidden md:hidden transition-opacity backdrop-blur-sm" onclick="ui.closeSidebar()"></div>

        <!-- Sidebar (Drawer on Mobile) -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-slate-900 text-white transform -translate-x-full md:translate-x-0 md:static md:w-64 flex flex-col border-r border-slate-800 transition-transform duration-300 z-40 h-full shadow-2xl md:shadow-none">
            <div class="h-16 flex items-center justify-between px-6 bg-slate-950 border-b border-slate-800 shrink-0">
                <div class="flex items-center">
                    <i data-lucide="building-2" class="text-brand-500 mr-3 h-6 w-6"></i>
                    <div>
                        <h1 class="text-lg font-bold tracking-wide">G-IMMO</h1>
                        <span class="text-[10px] text-orange-400 font-mono uppercase tracking-wider">Mobile</span>
                    </div>
                </div>
                <!-- Close button for mobile -->
                <button onclick="ui.closeSidebar()" class="md:hidden text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <!-- Recherche Globale -->
            <div class="px-4 py-4 border-b border-slate-800 shrink-0">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i data-lucide="search" class="w-4 h-4 text-slate-500"></i>
                    </div>
                    <input type="text" id="global-search" placeholder="Chercher client..." class="bg-slate-800 border border-slate-700 text-slate-300 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block w-full pl-10 p-3 placeholder-slate-500">
                </div>
                <div id="search-results" class="absolute left-4 right-4 mt-1 bg-white rounded-lg shadow-xl z-50 hidden max-h-60 overflow-y-auto border border-slate-200 text-slate-800"></div>
            </div>

            <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
                <a href="#" data-view="dashboard" class="nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="layout-dashboard" class="mr-3 h-5 w-5 opacity-70"></i> Tableau de bord
                </a>

                <div class="mt-6 mb-2 px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Gestion</div>
                <a href="#" data-view="properties" class="nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="home" class="mr-3 h-5 w-5 opacity-70"></i> Biens
                </a>
                <a href="#" data-view="tenants" class="nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="users" class="mr-3 h-5 w-5 opacity-70"></i> Locataires
                </a>
                <a href="#" data-view="leases" class="nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="file-contract" class="mr-3 h-5 w-5 opacity-70"></i> Baux & Contrats
                </a>

                <div class="mt-6 mb-2 px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Comptabilité</div>
                <a href="#" data-view="finance" class="nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="banknote" class="mr-3 h-5 w-5 opacity-70"></i> Transactions
                </a>
                <a href="#" data-view="reports" class="nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="file-spreadsheet" class="mr-3 h-5 w-5 opacity-70"></i> Bilans & Exports
                </a>

                <div class="mt-6 mb-2 px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Système</div>
                <a href="#" data-view="settings" class="nav-link group flex items-center px-3 py-3 text-sm font-medium rounded-md text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                    <i data-lucide="database-backup" class="mr-3 h-5 w-5 opacity-70"></i> Sauvegardes
                </a>
                <button onclick="location.reload()" class="mt-auto mb-4 mx-3 flex items-center px-3 py-3 text-sm font-medium rounded-md text-rose-400 border border-rose-900/30 hover:bg-rose-900/20 hover:text-rose-300 transition-colors">
                    <i data-lucide="log-out" class="mr-3 h-5 w-5 opacity-70"></i> Déconnexion
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 relative w-full">
            <!-- Mobile Header -->
            <div class="md:hidden bg-slate-900 text-white px-4 py-3 flex justify-between items-center no-print shadow-md z-30 shrink-0 sticky top-0">
                <span class="font-bold text-lg flex items-center gap-2"><i data-lucide="building-2" class="w-5 h-5 text-brand-500"></i> G-IMMO</span>
                <button onclick="ui.openSidebar()" class="p-2 -mr-2 text-slate-300 hover:text-white active:bg-slate-800 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
            </div>
            
            <div id="view-container" class="flex-1 overflow-y-auto overflow-x-hidden relative scroll-smooth"></div>
        </main>
    </div>

    <!-- Global Modal (Mobile Optimized) -->
    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-0 sm:p-4 transition-opacity no-print">
        <div id="modal-content" class="bg-white w-full h-full sm:h-auto sm:rounded-xl shadow-2xl sm:max-w-lg overflow-hidden transform transition-all flex flex-col sm:max-h-[90vh]"></div>
    </div>

    <!-- Loader Overlay -->
    <div id="loader" class="fixed inset-0 bg-white/90 z-[70] hidden flex flex-col items-center justify-center no-print">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-brand-100 border-t-brand-600"></div>
        <p class="mt-4 text-slate-800 font-bold" id="loader-text">Traitement...</p>
    </div>

    <!-- HIDDEN PRINT TEMPLATE FOR RECEIPTS -->
    <div id="receipt-print-area" class="hidden bg-white p-8"></div>

    <script>
        // --- 0. UI HELPERS & AUTH ---
        const ui = {
            openSidebar: () => {
                const sb = document.getElementById('sidebar');
                const bd = document.getElementById('mobile-sidebar-backdrop');
                sb.classList.remove('-translate-x-full');
                bd.classList.remove('hidden');
            },
            closeSidebar: () => {
                const sb = document.getElementById('sidebar');
                const bd = document.getElementById('mobile-sidebar-backdrop');
                sb.classList.add('-translate-x-full');
                bd.classList.add('hidden');
            }
        };

        const auth = {
            pin: '',
            target: '5008',
            press: (num) => {
                if(auth.pin.length < 4) {
                    auth.pin += num;
                    auth.updateUI();
                    if(auth.pin.length === 4) setTimeout(auth.check, 200);
                }
            },
            clear: () => {
                auth.pin = '';
                auth.updateUI();
            },
            updateUI: () => {
                for(let i=1; i<=4; i++) {
                    const dot = document.getElementById(`dot-${i}`);
                    if (i <= auth.pin.length) dot.classList.add('active');
                    else dot.classList.remove('active', 'error');
                }
            },
            check: () => {
                if(auth.pin === auth.target) {
                    const screen = document.getElementById('login-screen');
                    const app = document.getElementById('app-screen');
                    screen.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => { screen.style.display = 'none'; }, 500);
                    app.classList.remove('hidden');
                    void app.offsetWidth;
                    app.classList.remove('opacity-0');
                } else {
                    navigator.vibrate?.([50, 50, 50]);
                    for(let i=1; i<=4; i++) document.getElementById(`dot-${i}`).classList.add('error');
                    setTimeout(auth.clear, 500);
                }
            }
        };

        // --- 1. MOTEUR DE BASE DE DONNÉES ---
        const DB_NAME = 'GImmoCIDB';
        const DB_VERSION = 1;
        const STORE_FILES = 'files';

        const dbEngine = {
            init: () => new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains(STORE_FILES)) e.target.result.createObjectStore(STORE_FILES, { keyPath: 'id' }); };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            }),
            saveFile: async (fileObj) => {
                const db = await dbEngine.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_FILES], 'readwrite');
                    const record = { id: crypto.randomUUID(), name: fileObj.name, type: fileObj.type, blob: fileObj, date: new Date().toISOString() };
                    tx.objectStore(STORE_FILES).add(record).onsuccess = () => resolve(record.id);
                    tx.onerror = () => reject(tx.error);
                });
            },
            saveRestoredFile: async (fileRecord) => {
                const db = await dbEngine.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_FILES], 'readwrite');
                    tx.objectStore(STORE_FILES).put(fileRecord).onsuccess = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            getFile: async (id) => {
                const db = await dbEngine.init();
                return new Promise((resolve) => {
                    db.transaction([STORE_FILES], 'readonly').objectStore(STORE_FILES).get(id).onsuccess = (e) => resolve(e.target.result);
                });
            },
            getAllFiles: async () => {
                const db = await dbEngine.init();
                return new Promise(resolve => {
                    db.transaction([STORE_FILES], 'readonly').objectStore(STORE_FILES).getAll().onsuccess = e => resolve(e.target.result);
                });
            },
            clearFiles: async () => {
                const db = await dbEngine.init();
                return new Promise(resolve => {
                    db.transaction([STORE_FILES], 'readwrite').objectStore(STORE_FILES).clear().onsuccess = () => resolve();
                });
            }
        };

        // --- 2. STORE ---
        const initialState = {
            properties: [],
            tenants: [],
            leases: [],
            payments: [],
            expenses: [],
            logs: [],
            profile: { fullname: 'G-IMMO AGENCE', currency: 'FCFA', address: 'Abidjan, Cocody', phone: '+225 07 00 00 00' }
        };

        const store = {
            data: { ...initialState },
            load: () => {
                const stored = localStorage.getItem('g_immo_ci_v2_data');
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        if(parsed && typeof parsed === 'object') store.data = { ...initialState, ...parsed };
                    } catch(e) { console.error("Données locales corrompues"); }
                }
            },
            save: () => {
                if(store.data.logs.length > 500) store.data.logs = store.data.logs.slice(0, 500);
                try {
                    localStorage.setItem('g_immo_ci_v2_data', JSON.stringify(store.data));
                } catch(e) {
                    alert("Espace disque saturé. Impossible de sauvegarder.");
                }
            },
            add: (col, item) => { item.id = crypto.randomUUID(); item.createdAt = new Date().toISOString(); store.data[col].push(item); store.save(); return item; },
            update: (col, id, updates) => { const i = store.data[col].findIndex(x => x.id === id); if(i>-1) { store.data[col][i] = {...store.data[col][i], ...updates}; store.save(); return true; } return false; },
            delete: (col, id) => { store.data[col] = store.data[col].filter(x => x.id !== id); store.save(); },
            get: (col, id) => store.data[col].find(x => x.id === id)
        };

        // --- 3. UTILS ---
        const formatCurrency = (n) => new Intl.NumberFormat('fr-FR').format(n || 0) + ' FCFA';
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('fr-FR') : '-';
        const escapeHtml = (s) => (s || '').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const blobToDataURL = (blob) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        };
        
        // Native Download Function (removes FileSaver dependency)
        const downloadFile = (blob, fileName) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        };
        
        const loader = {
            show: (txt = 'Chargement...') => { document.getElementById('loader-text').innerText = txt; document.getElementById('loader').classList.remove('hidden'); },
            hide: () => document.getElementById('loader').classList.add('hidden')
        };

        const showToast = (msg, type = 'success') => {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            d.className = `${type === 'success' ? 'bg-emerald-600' : 'bg-rose-600'} text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 transform transition-all duration-300 translate-x-full max-w-sm pointer-events-auto shadow-2xl border border-white/10 backdrop-blur-md`;
            d.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-octagon'}" class="w-5 h-5 shrink-0"></i><span class="font-medium text-sm">${msg}</span>`;
            c.appendChild(d);
            lucide.createIcons();
            requestAnimationFrame(() => d.classList.remove('translate-x-full'));
            setTimeout(() => { d.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => d.remove(), 300); }, 3000);
        };

        const getPaymentStatus = (lease, periodStr) => {
            const payments = store.data.payments.filter(p => p.leaseId === lease.id && p.period === periodStr);
            const totalPaid = payments.reduce((sum, p) => sum + parseFloat(p.amount), 0);
            
            const [y, m] = periodStr.split('-');
            const limitDate = new Date(parseInt(y), parseInt(m) - 1, 10, 23, 59, 59);
            const now = new Date();

            if (totalPaid >= parseFloat(lease.rentAmount)) return { label: 'Payé', color: 'bg-emerald-100 text-emerald-800' };
            if (totalPaid > 0) return { label: 'Partiel', color: 'bg-amber-100 text-amber-800' };
            if (now > limitDate) return { label: 'En retard', color: 'bg-rose-100 text-rose-800' };
            return { label: 'En attente', color: 'bg-slate-100 text-slate-600' };
        };

        // --- 4. VUES ---
        const router = {
            current: 'dashboard',
            params: {},
            navigate: (view, params = {}) => {
                router.current = view;
                router.params = params;
                ui.closeSidebar(); // Close mobile menu on nav
                render();
            }
        };

        const components = {
            header: (title, subtitle, action = '') => `
                <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 sm:px-6 sticky top-0 z-20 shadow-sm no-print">
                    <div class="overflow-hidden">
                        <h2 class="text-lg sm:text-xl font-bold text-slate-800 truncate">${title}</h2>
                        ${subtitle ? `<p class="text-xs text-slate-500 mt-0.5 truncate">${subtitle}</p>` : ''}
                    </div>
                    <div class="flex gap-2 shrink-0">${action}</div>
                </header>
            `,
            statusBadge: (status, type='lease') => {
                if(type === 'lease') {
                    if(status === 'active') return `<span class="px-2 py-1 rounded-full text-[10px] uppercase font-bold bg-emerald-100 text-emerald-800 tracking-wide">Actif</span>`;
                    if(status === 'archived') return `<span class="px-2 py-1 rounded-full text-[10px] uppercase font-bold bg-slate-100 text-slate-500 tracking-wide">Clôturé</span>`;
                }
                return `<span>${status}</span>`;
            }
        };

        const views = {
            dashboard: () => { 
                const activeLeases = store.data.leases.filter(l => l.status === 'active');
                const income = store.data.payments.reduce((s, p) => s + parseFloat(p.amount), 0);
                return `
                    ${components.header('Tableau de Bord', 'Aperçu global')}
                    <div class="p-4 sm:p-6 overflow-y-auto h-full pb-24">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                             <div class="card p-4 border-l-4 border-l-brand-500"><p class="text-slate-500 text-[10px] font-bold uppercase">Biens</p><p class="text-xl sm:text-2xl font-bold text-slate-800 mt-1">${store.data.properties.length}</p></div>
                             <div class="card p-4 border-l-4 border-l-emerald-500"><p class="text-slate-500 text-[10px] font-bold uppercase">Baux</p><p class="text-xl sm:text-2xl font-bold text-slate-800 mt-1">${activeLeases.length}</p></div>
                             <div class="card p-4 border-l-4 border-l-indigo-500 col-span-2 md:col-span-1"><p class="text-slate-500 text-[10px] font-bold uppercase">Cautions</p><p class="text-xl sm:text-2xl font-bold text-slate-800 mt-1 truncate">${formatCurrency(activeLeases.reduce((s,l)=>s+parseFloat(l.depositAmount||0),0))}</p></div>
                             <div class="card p-4 border-l-4 border-l-rose-500 col-span-2 md:col-span-1"><p class="text-slate-500 text-[10px] font-bold uppercase">Revenus</p><p class="text-xl sm:text-2xl font-bold text-slate-800 mt-1 truncate">${formatCurrency(income)}</p></div>
                        </div>
                        <div class="card p-5 bg-gradient-to-br from-brand-900 to-slate-900 text-white shadow-lg">
                            <h3 class="font-bold mb-3">Actions Rapides</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="actions.openAddPayment()" class="bg-white/10 hover:bg-white/20 p-4 rounded-xl text-left transition active:scale-95"><i data-lucide="plus-circle" class="mb-2 w-6 h-6 text-emerald-400"></i><br><span class="font-semibold">Encaisser</span></button>
                                <button onclick="actions.openCreateLease()" class="bg-white/10 hover:bg-white/20 p-4 rounded-xl text-left transition active:scale-95"><i data-lucide="file-plus" class="mb-2 w-6 h-6 text-blue-400"></i><br><span class="font-semibold">Nouveau Bail</span></button>
                            </div>
                        </div>
                    </div>`;
            },
            properties: () => { 
                return `${components.header('Biens', 'Parc Immobilier', `<button onclick="actions.openCreateProperty()" class="btn-brand shadow-lg text-xs"><i data-lucide="plus" class="w-4 h-4"></i> Ajouter</button>`)}
                <div class="p-4 sm:p-6 pb-24 grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${store.data.properties.map(p => `
                    <div class="card p-5 relative group">
                        <div class="flex justify-between items-start mb-2">
                            <span class="bg-slate-100 text-slate-600 text-[10px] uppercase font-bold px-2 py-1 rounded tracking-wide">${escapeHtml(p.type)}</span>
                            <button onclick="actions.deleteItem('properties','${p.id}','Bien')" class="p-2 -m-2 text-rose-300 hover:text-rose-600 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800">${escapeHtml(p.nickname)}</h3>
                        <p class="text-sm text-slate-500 flex items-start gap-1 mt-1"><i data-lucide="map-pin" class="w-3 h-3 mt-0.5 shrink-0"></i> <span class="truncate-2-lines">${escapeHtml(p.address)}</span></p>
                    </div>`).join('')}
                </div>`; 
            },
            tenants: () => { 
                return `${components.header('Locataires', 'Répertoire', `<button onclick="actions.openCreateTenant()" class="btn-brand shadow-lg text-xs"><i data-lucide="plus" class="w-4 h-4"></i> Ajouter</button>`)}
                <div class="p-4 sm:p-6 pb-24 space-y-3">
                    ${store.data.tenants.map(t => `
                    <div class="card p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 active:bg-slate-100" onclick="router.navigate('tenantDetail', {id: '${t.id}'})">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-brand-100 text-brand-700 flex items-center justify-center font-bold text-sm shrink-0">${t.lastname.charAt(0)}${t.firstname.charAt(0)}</div>
                            <div>
                                <p class="font-bold text-slate-900">${escapeHtml(t.lastname)} ${escapeHtml(t.firstname)}</p>
                                <p class="text-xs text-slate-500">${escapeHtml(t.phone)}</p>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="text-slate-400 w-5 h-5"></i>
                    </div>`).join('')}
                </div>`; 
            },
            tenantDetail: () => { 
                const t = store.get('tenants', router.params.id);
                if (!t) return views.tenants();
                const leases = store.data.leases.filter(l => l.tenantId === t.id);
                const activeLease = leases.find(l => l.status === 'active');
                
                return `${components.header(t.lastname, 'Détail', `<button onclick="router.navigate('tenants')" class="text-xs border px-3 py-2 rounded-lg bg-white shadow-sm flex items-center gap-1"><i data-lucide="arrow-left" class="w-3 h-3"></i> Retour</button>`)}
                <div class="p-4 sm:p-6 pb-24 space-y-6">
                    <div class="card p-5">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <h3 class="text-xl font-bold text-slate-900">${t.firstname} ${t.lastname}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="bg-brand-50 text-brand-700 px-2 py-0.5 rounded text-xs font-mono">${t.phone}</span>
                                </div>
                            </div>
                            ${activeLease ? 
                                `<button onclick="actions.closeLease('${activeLease.id}')" class="w-full sm:w-auto text-rose-600 bg-rose-50 border border-rose-200 active:bg-rose-100 px-4 py-2 rounded-lg text-sm flex items-center justify-center gap-2 transition-colors"><i data-lucide="user-x" class="w-4 h-4"></i> Signaler Départ</button>` 
                                : '<span class="text-slate-400 text-sm italic">Aucun bail actif</span>'}
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-slate-500 text-xs uppercase tracking-wider mb-3 px-1">Historique des Baux</h4>
                        ${leases.map(l => views.renderLeaseCard(l, l.status === 'active')).join('')}
                    </div>
                </div>`;
            },
            renderLeaseCard: (lease, isActive) => {
                const prop = store.get('properties', lease.propertyId);
                const payments = store.data.payments.filter(p => p.leaseId === lease.id).sort((a,b) => b.date.localeCompare(a.date));
                return `<div class="card overflow-hidden mb-4 ${isActive?'border-brand-500 ring-1 ring-brand-100': 'opacity-80 bg-slate-50'}">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg text-slate-800">${prop?.nickname}</p>
                            <p class="text-xs text-slate-500 mt-0.5">Loyer: ${formatCurrency(lease.rentAmount)} • Caution: ${formatCurrency(lease.depositAmount)}</p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            ${components.statusBadge(lease.status)}
                            <button onclick="actions.editLease('${lease.id}')" class="p-2 text-slate-400 hover:text-brand-600 bg-white border border-slate-200 rounded-full shadow-sm"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    ${lease.contractFileId ? `<div class="bg-brand-50/50 px-4 py-2 border-b border-brand-100"><button onclick="actions.viewFile('${lease.contractFileId}')" class="text-xs text-brand-700 font-medium flex items-center gap-2"><i data-lucide="file-text" class="w-3 h-3"></i> Voir le contrat scanné</button></div>` : ''}
                    
                    <div class="p-2">
                        <div class="flex justify-between items-center px-2 py-2">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Paiements</p>
                        </div>
                        <div class="space-y-1">
                        ${payments.map(p => {
                            const st = getPaymentStatus(lease, p.period);
                            return `<div class="flex items-center justify-between p-2 rounded-lg bg-white border border-slate-100 shadow-sm">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono text-sm font-bold text-slate-700">${p.period}</span>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded ${st.color}">${st.label}</span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-0.5">${formatCurrency(p.amount)}</div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="actions.editPayment('${p.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-600 active:bg-slate-200"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                    <button onclick="actions.openReceiptGenerator('${p.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-brand-50 text-brand-600 active:bg-brand-100"><i data-lucide="printer" class="w-3 h-3"></i></button>
                                    ${p.receiptFileId ? `<button onclick="actions.viewFile('${p.receiptFileId}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-emerald-50 text-emerald-600 active:bg-emerald-100"><i data-lucide="file-check" class="w-3 h-3"></i></button>` : ''}
                                    <button onclick="actions.deletePayment('${p.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-rose-50 text-rose-600 active:bg-rose-100"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                </div>
                            </div>`
                        }).join('')}
                        </div>
                        ${payments.length === 0 ? '<div class="p-4 text-center text-xs text-slate-400 italic bg-slate-50 rounded mx-2 mb-2">Aucun historique</div>' : ''}
                    </div>
                </div>`;
            },
            leases: () => { return `${components.header('Baux', 'Contrats en cours', `<button onclick="actions.openCreateLease()" class="btn-brand shadow-lg text-xs"><i data-lucide="plus" class="w-4 h-4"></i> Nouveau</button>`)}<div class="p-4 sm:p-6 pb-24 space-y-3">${store.data.leases.filter(l=>l.status==='active').map(l => {
                const p = store.get('properties', l.propertyId);
                const t = store.get('tenants', l.tenantId);
                return `<div class="card p-4 flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                    <div>
                        <p class="font-bold text-slate-900">${t?.lastname} ${t?.firstname}</p>
                        <p class="text-sm text-slate-500">${p?.nickname} • <span class="font-mono text-slate-700">${formatCurrency(l.rentAmount)}</span></p>
                    </div>
                    <button onclick="actions.openAddPayment('${l.id}')" class="w-full sm:w-auto text-emerald-700 bg-emerald-100 active:bg-emerald-200 px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-colors text-center">Encaisser</button>
                </div>`;
            }).join('')}</div>`; },
            finance: () => { return `${components.header('Finance', 'Sorties', `<button onclick="actions.openCreateExpense()" class="btn-brand bg-rose-600 hover:bg-rose-700 text-xs"><i data-lucide="minus" class="w-4 h-4"></i> Sortie</button>`)}<div class="p-4 sm:p-6 pb-24 space-y-3">${store.data.expenses.map(e => `<div class="card p-4 flex justify-between items-center"><div class="overflow-hidden mr-3"><p class="font-medium text-slate-900 truncate">${escapeHtml(e.description)}</p><span class="text-xs text-slate-400 block">${formatDate(e.date)}</span></div><div class="text-right shrink-0"><p class="text-rose-600 font-bold text-lg">-${formatCurrency(e.amount)}</p>${e.fileId?`<button onclick="actions.viewFile('${e.fileId}')" class="text-[10px] text-brand-600 bg-brand-50 px-2 py-1 rounded mt-1">Justificatif</button>`:''}</div></div>`).join('')}</div>`; },
            reports: () => `
                ${components.header('Exports', 'Données')}
                <div class="p-4 sm:p-6 pb-24 max-w-3xl mx-auto space-y-6">
                    <div class="card p-5 border-l-4 border-indigo-500">
                        <h3 class="font-bold text-slate-800 text-lg mb-1">Rapport Financier</h3>
                        <p class="text-xs text-slate-500 mb-4">Export CSV pour Excel</p>
                        <form onsubmit="actions.exportTransactions(event)" class="grid grid-cols-1 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-100">
                            <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Du</label><input type="date" name="start" required class="input-clean bg-white"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Au</label><input type="date" name="end" required class="input-clean bg-white"></div>
                            <button type="submit" class="btn-brand bg-indigo-600 hover:bg-indigo-700 w-full mt-2">Générer CSV</button>
                        </form>
                    </div>
                </div>`,
            settings: () => `
                ${components.header('Backup', 'Données')}
                <div class="p-4 sm:p-6 pb-24 max-w-2xl mx-auto space-y-6">
                    <div class="card p-6 border-l-4 border-brand-500">
                        <h3 class="font-bold mb-2 text-lg">Sauvegarde Totale (JSON)</h3>
                        <p class="text-sm text-slate-500 mb-4">Génère un seul fichier contenant TOUTES les données et TOUS les PDF.</p>
                        <button onclick="actions.backupFull()" class="btn-brand w-full py-3">Télécharger Sauvegarde</button>
                    </div>
                    <div class="card p-6 border-l-4 border-amber-500">
                        <h3 class="font-bold mb-2 text-lg">Restaurer</h3>
                        <p class="text-sm text-slate-500 mb-4">Depuis un fichier .json</p>
                        <input type="file" id="restore-file" accept=".json" class="block w-full text-sm mb-4 bg-slate-50 p-2 rounded border"/>
                        <button onclick="actions.restoreFull()" class="btn-brand bg-amber-600 w-full hover:bg-amber-700">Restaurer</button>
                    </div>
                    <div class="text-center mt-8 pb-8">
                        <button onclick="if(confirm('Tout effacer ? Action irréversible.')) { localStorage.removeItem('g_immo_ci_v2_data'); dbEngine.clearFiles().then(() => location.reload()); }" class="text-rose-500 text-sm hover:underline p-4">Réinitialiser l'application</button>
                    </div>
                </div>`
        };

        // --- 5. ACTIONS & HANDLERS ---
        const actions = {
            openCreateProperty: () => modal.open('Nouveau Bien', `
                <form onsubmit="handlers.createProperty(event)" class="flex flex-col h-full sm:h-auto">
                    <div class="space-y-4 flex-1 overflow-y-auto p-1">
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Nom</label><input name="nickname" required class="input-clean" placeholder="Ex: Villa Cocody"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Adresse</label><input name="address" required class="input-clean"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Type</label>
                            <select name="type" class="input-clean">
                                <option>Appartement</option><option>Villa</option><option>Studio</option><option>Bureau</option><option>Magasin</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn-brand mt-4 w-full shadow-lg">Créer le Bien</button>
                </form>`),
            
            openCreateTenant: () => modal.open('Nouveau Locataire', `<form onsubmit="handlers.createTenant(event)" class="space-y-4"><div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Nom</label><input name="lastname" required class="input-clean"></div><div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Prénom</label><input name="firstname" required class="input-clean"></div><div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Téléphone</label><input name="phone" type="tel" required class="input-clean"></div><button class="btn-brand mt-4 w-full shadow-lg">Créer le Client</button></form>`),
            
            openCreateLease: () => {
                const props = store.data.properties.map(p => `<option value="${p.id}">${escapeHtml(p.nickname)}</option>`).join('');
                const tens = store.data.tenants.map(t => `<option value="${t.id}">${escapeHtml(t.lastname)} ${escapeHtml(t.firstname)}</option>`).join('');
                if(!props || !tens) return showToast('Créez d\'abord un bien et un client', 'error');
                
                modal.open('Nouveau Bail', `
                <form onsubmit="handlers.createLease(event)" class="flex flex-col h-full sm:h-auto">
                    <div class="space-y-4 flex-1 overflow-y-auto p-1">
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Bien</label><select name="propertyId" class="input-clean">${props}</select></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Locataire</label><select name="tenantId" class="input-clean">${tens}</select></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Loyer</label><input type="number" name="rentAmount" required class="input-clean"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Caution</label><input type="number" name="depositAmount" required class="input-clean"></div>
                        </div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Date Entrée</label><input type="date" name="startDate" required class="input-clean bg-white"></div>
                        <div><label class="text-xs font-bold text-brand-600 uppercase block mb-1">Contrat PDF (Scan)</label><input type="file" name="file" accept="application/pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 transition-colors"></div>
                    </div>
                    <button class="btn-brand mt-4 w-full shadow-lg">Valider le Bail</button>
                </form>`);
            },
            
            editLease: (id) => {
                const lease = store.get('leases', id);
                if(!lease) return;
                modal.open('Modifier le Bail', `
                <form onsubmit="handlers.updateLease(event, '${id}')" class="space-y-4">
                     <p class="text-xs text-amber-700 bg-amber-50 p-3 rounded-lg border border-amber-100 flex gap-2"><i data-lucide="alert-triangle" class="w-4 h-4 shrink-0"></i> Modification historique.</p>
                     <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Loyer</label><input type="number" name="rentAmount" value="${lease.rentAmount}" required class="input-clean"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Caution</label><input type="number" name="depositAmount" value="${lease.depositAmount}" required class="input-clean"></div>
                    </div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Date Entrée</label><input type="date" name="startDate" value="${lease.startDate}" required class="input-clean bg-white"></div>
                    <div><label class="text-xs font-bold text-brand-600 uppercase block mb-1">Remplacer PDF</label><input type="file" name="file" accept="application/pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700"></div>
                    <button class="btn-brand mt-4 w-full bg-amber-600 hover:bg-amber-700 shadow-lg">Enregistrer</button>
                </form>`);
            },

            editPayment: (id) => {
                const p = store.get('payments', id);
                if(!p) return;
                modal.open('Modifier Paiement', `
                <form onsubmit="handlers.updatePayment(event, '${id}')" class="space-y-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Période</label><input type="month" name="period" value="${p.period}" required class="input-clean bg-white"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Montant</label><input type="number" name="amount" value="${p.amount}" required class="input-clean"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Date</label><input type="date" name="date" value="${p.date.split('T')[0]}" required class="input-clean bg-white"></div>
                    </div>
                    <div><label class="text-xs font-bold text-emerald-600 uppercase block mb-1">Remplacer Reçu</label><input type="file" name="file" accept="application/pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700"></div>
                    <button class="btn-brand mt-4 w-full bg-amber-600 hover:bg-amber-700 shadow-lg">Mettre à jour</button>
                </form>`);
            },

            openAddPayment: (pid=null) => {
                const activeLeases = store.data.leases.filter(l => l.status === 'active');
                if(activeLeases.length === 0) return showToast('Aucun bail actif', 'error');

                const opts = activeLeases.map(l => {
                    const p = store.get('properties', l.propertyId);
                    const t = store.get('tenants', l.tenantId);
                    return `<option value="${l.id}" ${l.id===pid?'selected':''}>${t.lastname} - ${p.nickname} (${formatCurrency(l.rentAmount)})</option>`;
                }).join('');
                
                modal.open('Encaisser', `
                <form onsubmit="handlers.createPayment(event)" class="flex flex-col h-full sm:h-auto">
                    <div class="space-y-4 flex-1 overflow-y-auto p-1">
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Bail</label><select name="leaseId" class="input-clean">${opts}</select></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Période</label><input type="month" name="period" required class="input-clean bg-white"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Montant</label><input type="number" name="amount" required class="input-clean"></div>
                        </div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Date</label><input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="input-clean bg-white"></div>
                        <div><label class="text-xs font-bold text-emerald-600 uppercase block mb-1">Scan Reçu (Optionnel)</label><input type="file" name="file" accept="application/pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 transition-colors"></div>
                    </div>
                    <button class="btn-brand mt-4 w-full bg-emerald-600 hover:bg-emerald-700 shadow-lg">Enregistrer Paiement</button>
                </form>`);
            },
            
            openReceiptGenerator: (paymentId) => {
                const payment = store.get('payments', paymentId);
                const lease = store.get('leases', payment.leaseId);
                const tenant = store.get('tenants', lease.tenantId);
                const prop = store.get('properties', lease.propertyId);
                const profile = store.data.profile;

                modal.open('Générer Reçu', `
                    <div class="flex flex-col h-full sm:h-auto">
                        <div class="space-y-3 flex-1 overflow-y-auto p-1">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <p class="text-xs font-bold text-slate-500 uppercase mb-2">Émetteur</p>
                                <div class="space-y-2">
                                    <input id="r-sender-name" value="${profile.fullname}" class="input-clean py-2 text-sm" placeholder="Nom">
                                    <input id="r-sender-address" value="${profile.address}" class="input-clean py-2 text-sm" placeholder="Adresse">
                                    <input id="r-sender-phone" value="${profile.phone}" class="input-clean py-2 text-sm" placeholder="Téléphone">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Montant</label><input id="r-amount" value="${payment.amount}" class="input-clean"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Mode</label><input id="r-mode" value="Espèces" class="input-clean"></div>
                            </div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Titre</label><input id="r-title" value="QUITTANCE DE LOYER" class="input-clean font-bold"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Motif</label><input id="r-period" value="Loyer de ${payment.period}" class="input-clean"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Note</label><textarea id="r-note" class="input-clean" rows="2">Paiement reçu avec remerciements.</textarea></div>
                        </div>
                        <button onclick="actions.printReceipt('${payment.id}')" class="btn-brand mt-4 w-full justify-center shadow-lg"><i data-lucide="printer"></i> Imprimer / PDF</button>
                    </div>
                `);
            },

            printReceipt: (paymentId) => {
                const payment = store.get('payments', paymentId);
                const lease = store.get('leases', payment.leaseId);
                const tenant = store.get('tenants', lease.tenantId);
                const prop = store.get('properties', lease.propertyId);

                const title = document.getElementById('r-title').value;
                const amount = document.getElementById('r-amount').value;
                const mode = document.getElementById('r-mode').value;
                const period = document.getElementById('r-period').value;
                const note = document.getElementById('r-note').value;
                const senderName = document.getElementById('r-sender-name').value;
                const senderAddress = document.getElementById('r-sender-address').value;
                const senderPhone = document.getElementById('r-sender-phone').value;
                const date = new Date().toLocaleDateString('fr-FR');

                const html = `
                    <div style="font-family: 'Inter', sans-serif; max-width: 800px; margin: 0 auto; border: 2px solid #000; padding: 40px; position: relative;">
                        <div style="display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px;">
                            <div>
                                <h1 style="font-size: 24px; font-weight: bold; margin: 0;">${senderName}</h1>
                                <p style="margin: 5px 0;">${senderAddress}</p>
                                <p style="margin: 0;">Tel: ${senderPhone}</p>
                            </div>
                            <div style="text-align: right;">
                                <h2 style="font-size: 28px; font-weight: bold; color: #333; margin: 0;">${title}</h2>
                                <p style="margin-top: 10px;">Date: <strong>${date}</strong></p>
                                <p>N° Réf: #${paymentId.slice(0,8)}</p>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                            <p style="margin: 5px 0;">Reçu de : <strong>M./Mme ${tenant.lastname} ${tenant.firstname}</strong></p>
                            <p style="margin: 5px 0;">Pour le bien : <strong>${prop.nickname} - ${prop.address}</strong></p>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                            <tr style="background: #000; color: #fff;">
                                <th style="padding: 12px; text-align: left;">Désignation</th>
                                <th style="padding: 12px; text-align: right;">Montant</th>
                            </tr>
                            <tr>
                                <td style="padding: 15px; border-bottom: 1px solid #ddd;">${period}</td>
                                <td style="padding: 15px; border-bottom: 1px solid #ddd; text-align: right; font-weight: bold;">${formatCurrency(amount)}</td>
                            </tr>
                        </table>
                        <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                            <div style="width: 60%;">
                                <p><strong>Mode de règlement:</strong> ${mode}</p>
                                <p><strong>Note:</strong> ${note}</p>
                            </div>
                            <div style="text-align: center; border: 1px dashed #ccc; padding: 20px; width: 150px;">
                                <p style="margin-bottom: 40px; font-size: 12px; font-weight: bold;">Signature / Cachet</p>
                                <br>
                            </div>
                        </div>
                        <div style="position: absolute; bottom: 10px; left: 0; width: 100%; text-align: center; font-size: 10px; color: #999;">Document généré par G-IMMO le ${new Date().toLocaleString('fr-FR')}</div>
                    </div>
                `;

                const printArea = document.getElementById('receipt-print-area');
                printArea.innerHTML = html;
                window.print();
            },
            
            deletePayment: (id) => {
                if(confirm("Voulez-vous vraiment supprimer ce paiement / reçu ? Cette action est irréversible.")) {
                    store.delete('payments', id);
                    render();
                    showToast('Paiement supprimé', 'error');
                }
            },
            
            openCreateExpense: () => modal.open('Sortie Bailleur', `<form onsubmit="handlers.createExpense(event)" class="space-y-4"><input name="description" placeholder="Motif" required class="input-clean"><input type="number" name="amount" required class="input-clean"><input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="input-clean bg-white"><div><label class="text-xs font-bold text-rose-600 uppercase block mb-1">Justificatif PDF</label><input type="file" name="file" accept="application/pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-rose-50 file:text-rose-700"></div><button class="btn-brand mt-4 bg-rose-600 w-full shadow-lg">Enregistrer Sortie</button></form>`),
            
            closeLease: (id) => {
                if(confirm("Confirmer le départ du locataire ? Le bail sera archivé.")) {
                    store.update('leases', id, { status: 'archived', endDate: new Date().toISOString() });
                    render();
                    showToast('Bail clôturé');
                }
            },

            deleteItem: (col, id) => { if(confirm('Supprimer ?')) { store.delete(col, id); render(); } },
            viewFile: async (id) => { try { const f = await dbEngine.getFile(id); window.open(URL.createObjectURL(f.blob)); } catch(e){} },
            
            exportTransactions: (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const start = new Date(fd.get('start'));
                const end = new Date(fd.get('end')); end.setHours(23, 59, 59);

                const lines = [];
                lines.push("Date;Type;Bien;Locataire/Tiers;Description;Montant");
                store.data.payments.forEach(p => {
                    const d = new Date(p.date);
                    if(d>=start && d<=end) {
                        const l = store.get('leases', p.leaseId);
                        const t = l ? store.get('tenants', l.tenantId) : null;
                        const prop = l ? store.get('properties', l.propertyId) : null;
                        lines.push(`${formatDate(p.date)};ENTREE;${prop?prop.nickname:''};${t?t.lastname:''};Loyer ${p.period};${p.amount}`);
                    }
                });
                store.data.expenses.forEach(e => {
                     const d = new Date(e.date);
                    if(d>=start && d<=end) lines.push(`${formatDate(e.date)};SORTIE;-;-;${e.description};-${e.amount}`);
                });
                const blob = new Blob(["\ufeff"+lines.join("\n")], {type: 'text/csv'});
                downloadFile(blob, `Situation_Bailleur_${start.toISOString().slice(0,10)}.csv`);
            },
            
            backupFull: async () => {
                loader.show('Génération Sauvegarde Complète...');
                try {
                    // 1. Get all files
                    const files = await dbEngine.getAllFiles();
                    
                    // 2. Convert files to Base64 strings for embedding in JSON
                    const filesData = await Promise.all(files.map(async f => ({
                        id: f.id,
                        name: f.name,
                        type: f.type,
                        date: f.date,
                        data: await blobToDataURL(f.blob)
                    })));
                    
                    // 3. Create monolithic backup object
                    const backupObj = {
                        meta: {
                            version: '2.0',
                            type: 'G-IMMO_FULL_BACKUP',
                            date: new Date().toISOString()
                        },
                        store: store.data,
                        files: filesData
                    };
                    
                    // 4. Save as single JSON
                    const blob = new Blob([JSON.stringify(backupObj)], {type: "application/json"});
                    downloadFile(blob, `G-IMMO_FULL_BACKUP_${new Date().toISOString().slice(0,10)}.json`);
                } catch(e) {
                    alert("Erreur de sauvegarde: " + e.message);
                } finally {
                    loader.hide();
                }
            },
            
            restoreFull: async () => {
                const input = document.getElementById('restore-file');
                if(!input.files[0]) return alert('Sélectionnez un fichier JSON.');
                if(!confirm("ATTENTION: Toutes les données actuelles seront remplacées. Continuer ?")) return;
                
                loader.show('Restauration...');
                try {
                    const text = await input.files[0].text();
                    const json = JSON.parse(text);
                    
                    // Basic validation
                    if (!json.store || !Array.isArray(json.files)) {
                        throw new Error("Format de fichier invalide.");
                    }
                    
                    // 1. Restore Database files
                    await dbEngine.clearFiles();
                    for (const f of json.files) {
                        const res = await fetch(f.data);
                        const blob = await res.blob();
                        await dbEngine.saveRestoredFile({
                            id: f.id,
                            name: f.name,
                            type: f.type,
                            date: f.date,
                            blob: blob
                        });
                    }
                    
                    // 2. Restore LocalStorage Data
                    store.data = json.store;
                    store.save();
                    
                    alert("Restauration terminée avec succès !");
                    location.reload();
                } catch(e) {
                    alert("Erreur restauration: " + e.message);
                } finally {
                    loader.hide();
                }
            }
        };

        const handlers = {
            createProperty: (e) => { e.preventDefault(); store.add('properties', Object.fromEntries(new FormData(e.target))); modal.close(); render(); showToast('Bien créé'); },
            createTenant: (e) => { e.preventDefault(); store.add('tenants', Object.fromEntries(new FormData(e.target))); modal.close(); render(); showToast('Locataire créé'); },
            createLease: async (e) => { 
                e.preventDefault(); const fd = new FormData(e.target);
                const file = fd.get('file'); let fid = null;
                if(file.size > 0) fid = await dbEngine.saveFile(file);
                store.add('leases', {...Object.fromEntries(fd), status: 'active', contractFileId: fid}); 
                modal.close(); render(); showToast('Bail créé');
            },
            updateLease: async (e, id) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const updates = Object.fromEntries(fd);
                const file = fd.get('file');
                if(file && file.size > 0) {
                    const fid = await dbEngine.saveFile(file);
                    updates.contractFileId = fid;
                }
                delete updates.file;
                store.update('leases', id, updates);
                modal.close();
                render();
                showToast('Bail mis à jour');
            },
            createPayment: async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const lid = fd.get('leaseId');
                const per = fd.get('period');
                const amt = parseFloat(fd.get('amount'));
                const lease = store.get('leases', lid);
                const existing = store.data.payments.filter(p => p.leaseId === lid && p.period === per);
                const sumExisting = existing.reduce((s, p) => s + parseFloat(p.amount), 0);
                
                if (sumExisting + amt > parseFloat(lease.rentAmount)) {
                    if(!confirm(`Attention: Le montant dépasse le loyer prévu. Continuer ?`)) return;
                }
                const file = fd.get('file'); let fid = null;
                if(file.size > 0) fid = await dbEngine.saveFile(file);
                const newId = store.add('payments', {...Object.fromEntries(fd), receiptFileId: fid}).id;
                modal.close(); 
                render(); 
                showToast('Paiement enregistré');
                if(confirm("Voulez-vous générer un reçu maintenant ?")) setTimeout(() => actions.openReceiptGenerator(newId), 300);
            },
            updatePayment: async (e, id) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const updates = Object.fromEntries(fd);
                const file = fd.get('file');
                if(file && file.size > 0) {
                    const fid = await dbEngine.saveFile(file);
                    updates.receiptFileId = fid;
                }
                delete updates.file;
                store.update('payments', id, updates);
                modal.close();
                render();
                showToast('Paiement mis à jour');
            },
            createExpense: async (e) => { 
                e.preventDefault(); const fd = new FormData(e.target);
                const file = fd.get('file'); let fid = null;
                if(file.size > 0) fid = await dbEngine.saveFile(file);
                store.add('expenses', {...Object.fromEntries(fd), fileId: fid}); 
                modal.close(); render(); showToast('Sortie enregistrée');
            }
        };

        const modal = {
            open: (t, c) => { 
                const m = document.getElementById('modal-content');
                m.innerHTML = `
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-slate-800 text-lg">${t}</h3>
                        <button onclick="modal.close()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="p-4 sm:p-6 overflow-y-auto flex-1 h-full">${c}</div>
                `; 
                document.getElementById('modal-backdrop').classList.remove('hidden'); 
            },
            close: () => document.getElementById('modal-backdrop').classList.add('hidden')
        };

        const render = () => {
            const v = views[router.current] || views.dashboard;
            document.getElementById('view-container').innerHTML = v();
            lucide.createIcons();
        };

        const init = async () => {
            store.load();
            document.getElementById('sidebar').addEventListener('click', e => { const l = e.target.closest('.nav-link'); if(l) router.navigate(l.dataset.view); });
            // Search
            const search = document.getElementById('global-search');
            const resBox = document.getElementById('search-results');
            search.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase().replace(/[<>]/g, '');
                if(val.length < 2) { resBox.classList.add('hidden'); return; }
                const hits = store.data.tenants.filter(t => t.lastname.toLowerCase().includes(val) || t.firstname.toLowerCase().includes(val));
                resBox.innerHTML = hits.map(t => `<div class="p-4 hover:bg-slate-50 cursor-pointer border-b last:border-0" onclick="router.navigate('tenantDetail', {id:'${t.id}'}); document.getElementById('search-results').classList.add('hidden')"><div class="font-bold text-slate-900">${escapeHtml(t.lastname)} ${escapeHtml(t.firstname)}</div><div class="text-xs text-slate-500">${t.phone}</div></div>`).join('') || '<div class="p-4 text-sm text-slate-500">Aucun résultat</div>';
                resBox.classList.remove('hidden');
            });
            document.addEventListener('click', (e) => { if(!e.target.closest('#global-search')) resBox.classList.add('hidden'); });
            render();
        };
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
